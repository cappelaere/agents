# syntax=docker/dockerfile:1.6
FROM python:3.11-slim

ARG APP_HOME=/app
WORKDIR ${APP_HOME}

# System utilities
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python dependencies first for better layer caching
COPY requirements.txt ./requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

# Copy runtime assets
COPY ais_openapi.yml ./ais_openapi.yml
COPY env.sh ./env.sh
COPY docker-entrypoint.sh ./docker-entrypoint.sh
RUN chmod +x ./docker-entrypoint.sh

# Default environment
ENV OPENAPI_FILE=ais_openapi.yml
ENV HOST=0.0.0.0
ENV PORT=8100
# Set START_CMD to your library's launcher if different.
# Example: START_CMD="ais-agent --openapi ${OPENAPI_FILE} --host ${HOST} --port ${PORT}"
ENV START_CMD="uvicorn ais_agent:app --host 4{HOST} --port ${PORT} -reload"

EXPOSE 8100

# Optional healthcheck; disable or adjust path if your agent differs
HEALTHCHECK --interval=30s --timeout=5s --start-period=20s --retries=3 \
    CMD curl -fsS http://localhost:${PORT}/health || exit 1

ENTRYPOINT ["./docker-entrypoint.sh"]
